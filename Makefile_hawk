
MPI_RUN=mpirun
MPI_CC=mpicc



SRC_CUSTOM_PSEND=message-aggregation/custom_psend_aggregate_simple.c
# message-aggregation/intervals.c message-aggregation/custom_psend.c
SRC_NOPSEND=$(filter-out $(wildcard benchmarks/bench_psen*.c), $(SRC)) benchmarks/bench_psend_custom.c
SRC=$(wildcard benchmarks/*.c) $(filter-out get_status.c parrived.c interval_tree_test.c custom_psend_old.c custom_psend_new.c custom_psend_dummy.c win.c partitioned_get_status.c, $(wildcard *.c)) $(SRC_CUSTOM_PSEND)

CFLAGS=-fopenmp -lm -lpthread -I. -Wall -O1 -DNDEBUG

.phony: all bench run
all: bench

bench_dbg: $(SRC) bench.h test_cases.h
	$(MPI_CC) $(SRC) -o bench_dbg -Wall -g -lpthread -I. -lm

.phony: bin/bench_openmpi bin/bench_mpich bin/bench_impi bin/bench_cpe bin/bench_mpt
bin/bench_openmpi: $(SRC) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/13.1.0 openmpi/5.0.0 && $(MPI_CC) $(SRC) -o bin/bench_openmpi $(CFLAGS))
bin/bench_openmpi_503: $(SRC) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/13.1.0 openmpi/5.0.3 && $(MPI_CC) $(SRC) -o bin/bench_openmpi_503 $(CFLAGS))
bin/trace_openmpi_503: $(SRC) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/13.1.0 openmpi/5.0.3 && source ~/tracing-env.sh && scorep-mpicc $(SRC) -o bin/trace_openmpi_503 $(CFLAGS))
bin/bench_mpich: $(SRC) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/13.1.0 mpich/4.1.2 && $(MPI_CC) $(SRC) -o bin/bench_mpich $(CFLAGS))
bin/trace_mpich: $(SRC) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/13.1.0 mpich/4.1.2 && source ~/tracing-env-mpich.sh && scorep-mpicc $(SRC) -o bin/trace_mpich $(CFLAGS))
bin/bench_impi: $(SRC_NOPSEND) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/13.1.0 impi/2021.9.0 && $(MPI_CC) $(SRC_NOPSEND) -o bin/bench_impi $(CFLAGS) -DDISABLE_PSEND)
bin/bench_cpe: $(SRC_NOPSEND) bench.h test_cases.h
	echo $(shell module load CPE/23.12 && $(MPI_CC) $(SRC_NOPSEND) -o bin/bench_cpe $(CFLAGS) -DDISABLE_PSEND)
bin/bench_mpt: $(SRC_NOPSEND) bench.h test_cases.h
	echo $(shell module load hlrs-software-stack/current gcc/10.2.0 mpt/2.28 && $(MPI_CC) $(SRC_NOPSEND) -o bin/bench_mpt $(CFLAGS) -DDISABLE_PSEND)

bench: bin/bench_openmpi bin/bench_mpich bin/bench_impi bin/bench_cpe bin/bench_mpt
	echo 'Making benchmark binaries'

.phony: run_bench_openmpi run_bench_mpich run_bench_impi run_bench_cpe run_bench_mpt
run_bench_openmpi_default: bin/bench_openmpi_503
	rm -rf results/openmpi/5.0.3/default
	qsub pbs/bench_openmpi_503.pbs
run_trace_openmpi_default: bin/trace_openmpi_503
	rm -rf results/openmpi/5.0.3/trace-default
	qsub pbs/trace_openmpi_503.pbs
run_bench_openmpi_ucx: bin/bench_openmpi_503
	rm -rf results/openmpi/5.0.3/ucx
	qsub pbs/bench_openmpi_503_ucx.pbs
run_bench_openmpi_ob1: bin/bench_openmpi_503
	rm -rf results/openmpi/5.0.3/ob1
	qsub pbs/bench_openmpi_503_ob1.pbs
run_bench_openmpi_500_default: bin/bench_openmpi 
	rm -rf results/openmpi/5.0.0/default
	qsub pbs/bench_openmpi.pbs
run_bench_openmpi_500_ob1: bin/bench_openmpi 
	rm -rf results/openmpi/5.0.0/ob1
	qsub pbs/bench_openmpi_ob1.pbs
run_bench_openmpi_500_ucx: bin/bench_openmpi 
	rm -rf results/openmpi/5.0.0/ucx
	qsub pbs/bench_openmpi_ucx.pbs

run_bench_openmpi: run_bench_openmpi_default run_bench_openmpi_ucx run_bench_openmpi_ob1
run_bench_openmpi_500: run_bench_openmpi_500_default run_bench_openmpi_500_ucx run_bench_openmpi_500_ob1

run_bench_mpich: bin/bench_mpich
	rm -rf results/mpich/*/
	qsub pbs/bench_mpich.pbs
run_trace_mpich: bin/trace_mpich
	rm -rf results/mpich/4.1.2-trace/
	qsub pbs/trace_mpich.pbs
run_bench_impi: bin/bench_impi
	rm -rf results/impi/*/
	qsub pbs/bench_impi.pbs
run_bench_cpe: bin/bench_cpe
	rm -rf results/cpe/*/
	qsub pbs/bench_cpe.pbs
run_bench_mpt: bin/bench_mpt
	rm -rf results/mpt/*/
	qsub pbs/bench_mpt.pbs

run: run_bench_openmpi run_bench_mpich run_bench_impi run_bench_cpe run_bench_mpt

